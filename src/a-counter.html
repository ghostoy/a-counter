<polymer-element name="a-counter"
		 attributes="value max-length pre post hold">

	<template>
		<style>

		:host {
			display	: block;
		}

		:host([animation=none]) > #container > li > div.num {
			transition	: none;
		}

		:host([animation=super-fast]) > #container > li > div.num {
			transition	: -webkit-transform 0.5s ease-in-out;
			transition	: -moz-transform 0.5s ease-in-out;
			transition	: -ms-transform 0.5s ease-in-out;
			transition	: -o-transform 0.5s ease-in-out;
			transition	: transform 0.5s ease-in-out;
		}

		:host([animation=fast]) > #container > li > div.num {
			transition	: -webkit-transform 1s ease-in-out;
			transition	: -moz-transform 1s ease-in-out;
			transition	: -ms-transform 1s ease-in-out;
			transition	: -o-transform 1s ease-in-out;
			transition	: transform 1s ease-in-out;
		}

		:host([animation=slow]) > #container > li > div.num {
			transition	: -webkit-transform 4s ease-in-out;
			transition	: -moz-transform 4s ease-in-out;
			transition	: -ms-transform 4s ease-in-out;
			transition	: -o-transform 4s ease-in-out;
			transition	: transform 4s ease-in-out;
		}
		
		#container {
			display		: -webkit-flex;
			display		: -moz-flex;
			display		: -ms-flex;
			display 	: -ms-flexbox;
			display 	: -o-flex;
			display 	: flex;
			list-style 	: none;
			margin 		: 0px;
			padding 	: 0px;
		}
		#container > li {
			-webkit-flex: 1 1;
			-moz-flex	: 1 1;
			-ms-flex 	: 1 1;
			-o-flex		: 1 1;
			flex 		: 1 1;
			height 		: 100%;
			overflow 	: hidden;
			/*background: linear-gradient(0deg, rgba(0,0,0,0.5), rgba(255,255,255,0.5), rgba(0,0,0,0.5));*/
		}
		#container > li > div {
			position	: relative;
			text-align	: center;
			top 		: 0px;
			transition	: -webkit-transform 2s ease-in-out;
			transition	: -moz-transform 2s ease-in-out;
			transition	: -ms-transform 2s ease-in-out;
			transition	: -o-transform 2s ease-in-out;
			transition	: transform 2s ease-in-out;
		}
		</style>
		<ul id="container">
		</ul>
	</template>

	<script>
		Polymer('a-counter', {
			value: 0,
			"max-length": 3,
			pre: '',
			post: '',
			hold: false,
			valueChanged: function(oldValue){
				var newValue = this.value;
				if (Math.log(newValue)/Math.LN10>this['max-length']) {
					this.value = oldValue;
					return;
				}

				this.updateValue();
			},
			preChanged: function(oldValue) {
				var newValue = this.pre;
				if (oldValue && newValue.length > oldValue.length) {
					this.pre = newValue.substr(0, oldValue.length);
					return;
				}
				var childNodes = this.$.container.childNodes;
				for(var i = 0; i < this.pre.length; i++) {
					childNodes[i].firstChild.innerHTML = this.pre.charAt(i);
				}
			},
			postChanged: function(oldValue) {
				var newValue = this.post;
				if (oldValue && newValue.length > oldValue.length) {
					this.post = newValue.substr(0, oldValue.length);
					return;
				}

				var offset = this['max-length'] + this.pre.length;
				var childNodes = this.$.container.childNodes;
				for(var i = 0; i < this.post.length; i++) {
					childNodes[offset + i].firstChild.innerHTML = this.post.charAt(i);
				}
			},
			holdChanged: function(oldValue) {
				if (!this.hold) {
					this.updateValue();
				}
			},
			enteredView: function() {
				var container = this.$.container;
				var style = document.defaultView.getComputedStyle(this);
				var fontSize = container.style.lineHeight = container.style.height = style.getPropertyValue('font-size');
			},
			ready: function() {
				var container = this.$.container;

				var maxLength = this['max-length'];
				var preLength = this.pre.length;
				var postLength = this.post.length;

				var digits = '<li><div class="num"><div>'+[0,1,2,3,4,5,6,7,8,9].join('</div><div>')+'</div></div></li>';
				var nums = new Array(maxLength + preLength + postLength);
				for(var i = 0; i < nums.length; i++) {
					if (i < preLength) {
						nums[i] = '<li><div>' + this.pre.charAt(i) + '</div></li>';
					} else if (i >= preLength + maxLength) {
						nums[i] = '<li><div>' + this.post.charAt(i - preLength - maxLength) + '</div></li>';
					} else {
						nums[i] = digits;
					}
				}
				container.innerHTML = nums.join('');
			},
			updateValue: function() {
				if (this.hold) return;
				if (document.body.classList.contains('polymer-veiled')) {
					setTimeout(this.updateValue.bind(this), 100);
					return;
				}

				var value = parseInt(this.value);
				var maxLength = parseInt(this['max-length']);
				var preLength = this.pre.length;
				var listItems = this.$.container.childNodes;
				for(var i = 0; i < maxLength; i++) {
					var d = value % 10;
					var el = listItems[maxLength + preLength - 1 - i].firstChild;
					translateY(el, value % 10);
					value = Math.floor(value / 10);
				}

				function translateY(el, value) {
					el.style.webkitTransform
					= el.style.mozTransform
					= el.style.msTransform
					= el.style.oTransform
					= el.style.transform
					= 'translateY(-'+(value*10)+'%)';
				}
			}
		});
	</script>

</polymer-element>
